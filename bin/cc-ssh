#!/usr/bin/env bash
# cssh - Chameleon ssh wrapper
# 
# Provides a wrapper around ssh with some specific use-cases
# for accessing Chameleon hosts.
set -e -u -o pipefail

host="${1:-}"

declare -a cmd

with_password() {
  export SSHPASS="$1"
}

case "$host" in
  # Production TACC nodes - use TACC account and access
  # via a development portal.
  chameleon06.tacc.utexas.edu|master2.chameleon.tacc.utexas.edu)
    with_password "$TACC_PASSWORD"
    cmd+=(sshpass -e ssh -o"User=$TACC_USERNAME")
    cmd+=(-o"ProxyCommand=sshpass -e ssh -W %h:%p $TACC_USERNAME@chameleon01.tacc.utexas.edu")
    ;;
    # All other TACC nodes - use TACC account
  *.tacc.utexas.edu)
    with_password "$TACC_PASSWORD"
    cmd+=(sshpass -e ssh -o"User=$TACC_USERNAME")
    ;;
  # UChicago nodes - use TACC account and access via a development portal.
  # Uses SSH key authentication via SSH agent for the last hop.
  *.uc.chameleoncloud.org)
    with_password "$TACC_PASSWORD"
    cmd+=(sshpass -e ssh -o"User=$UC_USERNAME")
    cmd+=(-o"ProxyCommand=ssh -W %h:%p $TACC_USERNAME@chameleon01.tacc.utexas.edu")
    ;;
  # Everything else - just try it.
  *)
    echo "I don't really know how to handle $host, but I'll try." >&2
    cmd+=(ssh)
    ;;
esac

cmd+=("$@")
"${cmd[@]}"
