#!/usr/bin/env bash
# cc-ssh - Chameleon ssh wrapper
#
# Provides a wrapper around ssh/scp with some specific use-cases
# for accessing Chameleon hosts.
set -e -u -o pipefail

tacc_jump_host="chameleon01.tacc.utexas.edu"
anl_jump_host="login.mcs.anl.gov"

config="$(mktemp)"
ssh="ssh -F $config"
cat >"$config" <<SSH_CONFIG
Host chameleon06.tacc.utexas.edu master2.chameleon.tacc.utexas.edu
  User $TACC_USER
  ProxyJump $TACC_USER@$tacc_jump_host

Host *.tacc.utexas.edu
  User $TACC_USER

Host 10.*%tacc
  ProxyCommand ssh -tF "$config" $tacc_jump_host sudo ssh cc@%h:%p

Host *%tacc
  ProxyCommand ssh -tF "$config" $tacc_jump_host sudo ssh %h:%p

Host *.uc.chameleoncloud.org
  User $UC_USER
  ProxyJump $ANL_USER@$anl_jump_host

Host 10.*%uc
  ProxyCommand ssh -F "$config" $anl_jump_host sudo ssh cc@%h:%p

Host *%uc
  ProxyCommand ssh -F "$config" $anl_jump_host sudo ssh %h:%p
SSH_CONFIG

cleanup() {
  rm -f "$config"
}
trap cleanup EXIT

cmd="${1:-ssh}"
shift

exec "$cmd" -F "$config" "$@"
