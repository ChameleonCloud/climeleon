#!/usr/bin/env bash
# cc-ssh - Chameleon ssh wrapper
#
# Provides a wrapper around ssh/scp with some specific use-cases
# for accessing Chameleon hosts.
set -e -u -o pipefail

tacc_jump_host="staff.chameleon.tacc.utexas.edu"
anl_jump_host="login.mcs.anl.gov"

config="$(mktemp)"
ssh="ssh -F $config"
cat >"$config" <<SSH_CONFIG
Host *.chameleon.tacc.utexas.edu chameleon06.tacc.utexas.edu dev.tacc.chameleoncloud.org
  User $TACC_USER
  ProxyCommand ssh -qW %h:%p $TACC_USER@$tacc_jump_host

Host *.tacc.utexas.edu *.tacc.chameleoncloud.org
  User $TACC_USER

Host *.uc.chameleoncloud.org
  User $UC_USER
  ProxyCommand ssh -qW %h:%p $ANL_USER@$anl_jump_host

Host *.mcs.anl.gov !$anl_jump_host
  User $ANL_USER
  ProxyCommand ssh -qW %h:%p $ANL_USER@$anl_jump_host

Host *.northwestern.edu
  User $NU_USER
SSH_CONFIG

cleanup() {
  rm -f "$config"
}
trap cleanup EXIT

cmd="${1:-ssh}"
shift

if [[ "$1" == "config" ]]; then
  cat "$config"
else
  exec "$cmd" -F "$config" "$@"
fi
